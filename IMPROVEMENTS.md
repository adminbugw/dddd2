# 版本升级和端口扫描优化

## 改进内容

### 1. nuclei 版本升级
- 从 v3.0.2 升级到 v3.7.0
- 更新 go.mod 文件中的依赖版本

### 2. 端口扫描优化

#### 2.1 性能改进
- 添加扫描统计信息 (PortScanStats)
- 实现实时进度报告 (每10秒输出一次)
- 增加最大并发数限制 (500个worker)
- 优化并发通道缓冲区大小 (workers*2)

#### 2.2 功能增强
- 添加扫描速度和预计剩余时间计算
- 优化黑名单锁定机制 (从 Mutex 改为 RWMutex)
- 增加扫描目标总数和端口数量统计
- 改进错误处理和日志输出

#### 2.3 代码质量
- 添加详细的日志记录
- 优化 goroutine 管理
- 添加扫描完成统计信息
- 改进代码可读性和维护性

### 3. ICMP 探测优化

#### 3.1 性能改进
- 添加 ICMP 探测统计信息 (ICMPStats)
- 实现实时进度报告 (每5秒输出一次)
- 优化并发控制

#### 3.2 功能增强
- 添加成功率统计
- 添加平均扫描速度计算
- 改进探测策略选择逻辑
- 增强日志输出信息

#### 3.3 探测流程优化
1. 优先尝试 ICMP 原生套接字批量探测
2. 失败后尝试 ICMP 回显探测
3. 最后降级到系统 ping 命令
4. 每种方法都有明确的日志提示

## 主要优势

### 1. 更新 nuclei 引擎
- 获得最新的漏洞模板
- 性能提升和 bug 修复
- 更好的模板支持和 DSL 功能

### 2. 扫描速度提升
- 更高的并发控制
- 更好的资源利用率
- 减少不必要的等待时间

### 3. 可观测性增强
- 实时进度显示
- 扫描速度监控
- 预计剩余时间
- 详细的统计信息

### 4. 代码质量提升
- 更好的错误处理
- 更清晰的日志输出
- 更易于维护和扩展

## 使用示例

### 端口扫描
```bash
# 扫描单个IP的常用端口
./dddd -t 192.168.1.1 -p 80,443,22,3389

# 扫描网段
./dddd -t 192.168.1.0/24 -p 1-65535

# 使用 SYN 扫描 (需要安装 masscan)
./dddd -t 192.168.1.0/24 -p 1-65535 -scan-type syn
```

### ICMP 探测
```bash
# ICMP 探测 (默认启用)
./dddd -t 192.168.1.0/24

# 禁用 ICMP 探测
./dddd -t 192.168.1.0/24 -no-icmp-ping

# 启用 TCP 存活探测
./dddd -t 192.168.1.0/24 -tcp-ping
```

## 扫描统计信息

### TCP 端口扫描统计
- TotalScanned: 总扫描数
- SuccessScanned: 成功连接数
- FailedScanned: 失败连接数
- Blacklisted: 被黑名单的 IP 数

### ICMP 探测统计
- TotalSent: 总发送数
- SuccessCount: 成功响应数
- FailedCount: 失败数

## 性能建议

1. 对于大型网段扫描，建议使用 SYN 扫描模式
2. 合理设置并发线程数，避免占用过多资源
3. 根据网络环境调整超时时间
4. 使用端口黑名单排除不需要扫描的端口

## 注意事项

1. SYN 扫描需要 root 权限和 masscan 工具
2. ICMP 原生套接字在某些环境可能受限
3. 黑名单机制会自动过滤开放端口过多的目标
4. 扫描速度受网络环境和目标主机响应时间影响

## 未来优化方向

1. 支持更多扫描模式 (UDP、SCTP 等)
2. 添加自定义端口模板
3. 支持扫描结果导出为多种格式
4. 添加扫描任务暂停和恢复功能
5. 实现更智能的扫描策略
